<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor PDF básico</title>
  <link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#007bff" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body {
      body {
  font-family: 'Roboto', sans-serif;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  background: #f5f5f5;
  color: #222;
  display: flex;
  flex-direction: column;
}

#app-container {
  flex: 1;
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
  box-sizing: border-box;
}
    
   h1, h2, button {
      font-family: 'Poppins', sans-serif;
      text-align: center;
      margin-bottom: 20px;
    }
    .section {
  font-family: 'Poppins', sans-serif;
  margin-bottom: 15px;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  width: 100%;
  box-sizing: border-box;
}
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
    }
    input[type=file] {
      width: 100%;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 15px;
      margin-right: 10px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #0056b3;
    }
/* Botones de íconos compactos */
.file-actions button {
  width: 32px;
  height: 32px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

/* Efecto hover */
.file-actions button:hover {
  background: #e0e0e0;
  transform: scale(1.1);
}

/* Color para botón borrar */
.file-actions .delete-btn {
  background: #ffebee;
  color: #d32f2f;
}

/* Tooltips */
.file-actions button[title] {
  position: relative;
}

.file-actions button[title]:hover::after {
  content: attr(title);
  position: absolute;
  bottom: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: #333;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  white-space: nowrap;
}
    #fileList, #imageList {
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      background: #fafafa;
      font-size: 14px;
      margin-bottom: 10px;
    }
    #fileList div, #imageList div {
      margin-bottom: 5px;
    }
    #downloadLink {
      display: inline-block;
      margin-top: 10px;
      font-weight: bold;
      text-decoration: none;
      color: #28a745;
    }
/* Estilos para el historial de archivos */
.files-history {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.files-history li {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  border-bottom: 1px solid #e0e0e0;
  background: white;
}

.files-history li:hover {
  background-color: #f8f9fa;
}

.file-actions {
  display: flex;
  gap: 8px;
}

.file-info {
  flex-grow: 1;
}

.file-date {
  font-size: 0.85em;
  color: #666;
  margin-left: 10px;
}

#noFilesMessage {
  text-align: center;
  padding: 20px;
  color: #666;
  font-style: italic;
}

#savedFilesContainer {
  margin-top: 20px;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.files-history {
  max-height: 300px;
  overflow-y: auto;
}

@media (min-width: 768px) {
  .columns {
    display: flex;
    gap: 20px;
  }
  
  .column {
    flex: 1;
  }
}

@media (max-width: 767px) {
  body {
    padding: 10px;
  }
  
  button {
    width: 100%;
    margin-bottom: 10px;
  }
  
  .file-actions {
    flex-direction: column;
  }
}

/* Animación para el modal */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Estilo para el input de nombre */
#fileNameInput:focus {
  border-color: #007bff;
  outline: none;
  box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
}
  </style>
</head>
<body>

<div id="app-container">
  <h2>Editor PDF Básico</h2>

  <div class="section">
    <label for="pdfInput">Seleccionar PDFs para unir</label>
    <input id="pdfInput" type="file" accept="application/pdf" multiple />
    <div id="fileList"></div>
    <button id="mergeBtn">Unir PDFs</button>
  </div>

  <div class="section">
    <label for="imageInput">Seleccionar imágenes para convertir a PDF</label>
    <input id="imageInput" type="file" accept="image/*" multiple />
    <div id="imageList"></div>
    <button id="imgToPdfBtn">Convertir imágenes a PDF</button>
  </div>

  <div class="section">
    <label for="singlePdfInput">Seleccionar un PDF para añadir números de página</label>
    <input id="singlePdfInput" type="file" accept="application/pdf" />
    <button id="addPageNumsBtn">Añadir números de página</button>
  </div>

  <div class="section">
  <label for="orderPdfInput">Seleccionar un PDF para ordenar páginas</label>
  <input id="orderPdfInput" type="file" accept="application/pdf" />
  <div id="pageOrderList" style="max-height:150px; overflow-y:auto; border:1px solid #ddd; padding:5px; margin-top:8px; background:#fafafa;"></div>
  <button id="orderPagesBtn">Guardar PDF ordenado</button>
</div>

  <a id="downloadLink" style="display:none;" download="output.pdf"></a>

</div>

<script>
async function getCustomFileName(defaultName) {
  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.style = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    `;
    
    modal.innerHTML = `
      <div style="
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 400px;
      ">
        <h3 style="margin-top: 0">Nombre del archivo</h3>
        <input 
          type="text" 
          id="fileNameInput" 
          value="${defaultName}" 
          style="
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
          "
        >
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
          <button id="cancelBtn" style="padding: 8px 15px; background: #f0f0f0;">Cancelar</button>
          <button id="saveBtn" style="padding: 8px 15px; background: #007bff; color: white;">Guardar</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    const input = modal.querySelector('#fileNameInput');
    input.select();
    
    modal.querySelector('#saveBtn').addEventListener('click', () => {
      const fileName = input.value.trim() || defaultName;
      if (!fileName.endsWith('.pdf')) {
        resolve(`${fileName}.pdf`);
      } else {
        resolve(fileName);
      }
      modal.remove();
    });
    
    modal.querySelector('#cancelBtn').addEventListener('click', () => {
      resolve(defaultName);
      modal.remove();
    });
  });
}
  const { PDFDocument, StandardFonts, rgb } = PDFLib;

  // Elementos DOM
  const pdfInput = document.getElementById('pdfInput');
  const fileList = document.getElementById('fileList');
  const mergeBtn = document.getElementById('mergeBtn');

  const imageInput = document.getElementById('imageInput');
  const imageList = document.getElementById('imageList');
  const imgToPdfBtn = document.getElementById('imgToPdfBtn');

  const singlePdfInput = document.getElementById('singlePdfInput');
  const addPageNumsBtn = document.getElementById('addPageNumsBtn');

  const downloadLink = document.getElementById('downloadLink');

  // Variables para guardar archivos cargados
  let pdfFiles = [];
  let imageFiles = [];
  let singlePdfFile = null;

  // Cargar PDFs para unir
  pdfInput.addEventListener('change', async (e) => {
    pdfFiles = Array.from(e.target.files);
    renderFileList(fileList, pdfFiles);
  });

  // Cargar imágenes para convertir
  imageInput.addEventListener('change', async (e) => {
    imageFiles = Array.from(e.target.files);
    renderFileList(imageList, imageFiles);
  });

  // Cargar PDF único para números de página
  singlePdfInput.addEventListener('change', async (e) => {
    singlePdfFile = e.target.files[0] || null;
  });

  // Función para mostrar lista simple de archivos
  function renderFileList(container, files) {
    container.innerHTML = '';
    if (files.length === 0) {
      container.textContent = 'No hay archivos seleccionados.';
      return;
    }
    files.forEach((file, i) => {
      const div = document.createElement('div');
      div.textContent = `${i+1}. ${file.name} (${Math.round(file.size/1024)} KB)`;
      container.appendChild(div);
    });
  }

<div class="columns">
<div class="column">
    <!-- Sección Unir PDFs -->
    <div class="section">
</div>

    <!-- Sección Convertir imágenes -->
<div class="section">
  
</div>
</div>

  <!-- Columna derecha -->
<div class="column">
    <!-- Sección Numerar páginas -->
<div class="section">
</div>

    <!-- Sección Ordenar páginas -->
<div class="section">
      
</div>
</div>
</div>

</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log('Service Worker registrado'))
      .catch(err => console.log('Error registrando SW:', err));
  }
</script>

<script>

// ===== IndexedDB Setup =====
let db;
const request = indexedDB.open("PDFStorage", 1);

request.onupgradeneeded = function(e) {
  db = e.target.result;
  if (!db.objectStoreNames.contains("pdfs")) {
    db.createObjectStore("pdfs", { keyPath: "id", autoIncrement: true });
  }
};

request.onsuccess = function(e) {
  db = e.target.result;
  displayFiles();
};

request.onerror = function() {
  console.error("Error al abrir IndexedDB");
};

// Guardar PDF en IndexedDB
function savePDF(name, blob) {
  const tx = db.transaction("pdfs", "readwrite");
  const store = tx.objectStore("pdfs");
  store.add({ name: name, blob: blob, date: new Date() });
  tx.oncomplete = () => displayFiles();
}

// Mostrar archivos guardados
function displayFiles() {
  const list = document.getElementById("savedFilesList");
  const noFilesMsg = document.getElementById("noFilesMessage");
  list.innerHTML = "";
  
  const tx = db.transaction("pdfs", "readonly");
  const store = tx.objectStore("pdfs");
  
  store.getAll().onsuccess = function(e) {
    const files = e.target.result;
    
    if (files.length === 0) {
      noFilesMsg.style.display = "block";
      return;
    }
    
    noFilesMsg.style.display = "none";
    files.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    files.forEach(file => {
      const li = document.createElement("li");
      
      const fileInfo = document.createElement("div");
      fileInfo.className = "file-info";
      fileInfo.innerHTML = `
        <strong>${file.name}</strong>
        <span class="file-date">${new Date(file.date).toLocaleString()} · ${Math.round(file.blob.size/1024)} KB</span>
      `;
      
      const actions = document.createElement("div");
      actions.className = "file-actions";
      
      // Botón Abrir (solo ícono)
const openBtn = document.createElement("button");
openBtn.innerHTML = '<i class="fas fa-eye"></i>';
openBtn.title = "Abrir"; // Tooltip al pasar el mouse
      openBtn.className = "icon-btn";
      openBtn.onclick = () => {
        const url = URL.createObjectURL(file.blob);
        window.open(url, '_blank');
        URL.revokeObjectURL(url);
      };
      
      // Botón Descargar (solo ícono)
const downloadBtn = document.createElement("button");
downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
downloadBtn.title = "Descargar";
      downloadBtn.className = "icon-btn";
      downloadBtn.onclick = () => {
        const url = URL.createObjectURL(file.blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = file.name;
        a.click();
        URL.revokeObjectURL(url);
      };
      
      // Botón Borrar (solo ícono)
const deleteBtn = document.createElement("button");
deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
deleteBtn.title = "Borrar";
      deleteBtn.className = "icon-btn delete-btn";
      deleteBtn.onclick = () => {
        if (confirm(`¿Seguro que quieres borrar "${file.name}"?`)) {
          const delTx = db.transaction("pdfs", "readwrite");
          delTx.objectStore("pdfs").delete(file.id);
          delTx.oncomplete = () => displayFiles();
        }
      };
      
      actions.appendChild(openBtn);
      actions.appendChild(downloadBtn);
      actions.appendChild(deleteBtn);
      li.appendChild(fileInfo);
      li.appendChild(actions);
      list.appendChild(li);
    });
  };
}

// === Modificar tus funciones para guardar ===
// Ejemplo: en vez de solo descargar, también guardamos:
// === Función mejorada para guardar y descargar ===
async function downloadAndSavePDF(pdfDoc, fileName) {
  try {
    const bytes = await pdfDoc.save();
    const blob = new Blob([bytes], { type: "application/pdf" });
    
    // Guardar en IndexedDB
    const tx = db.transaction("pdfs", "readwrite");
    const store = tx.objectStore("pdfs");
    await new Promise((resolve, reject) => {
      const request = store.add({ 
        name: fileName, 
        blob: blob, 
        date: new Date() 
      });
      request.onsuccess = () => {
        displayFiles(); // Actualizar la lista
        resolve();
      };
      request.onerror = (event) => {
        console.error("Error al guardar:", event.target.error);
        reject(event.target.error);
      };
    });
    
    // Descargar archivo
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
    
    return true;
  } catch (error) {
    console.error("Error en downloadAndSavePDF:", error);
    alert("Error al generar el PDF: " + error.message);
    return false;
  }
}

</script>

<script>

// Unir PDFs
  mergeBtn.addEventListener('click', async () => {
  if (pdfFiles.length === 0) {
    alert('Selecciona al menos un PDF para unir.');
    return;
  }

  const fileName = await getCustomFileName('PDF_Unido.pdf');
  const mergedPdf = await PDFDocument.create();

    try {
      for (const file of pdfFiles) {
        const arrayBuffer = await file.arrayBuffer();
        const pdfDoc = await PDFDocument.load(arrayBuffer);
        const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
        copiedPages.forEach(page => mergedPdf.addPage(page));
      }

   downloadAndSavePDF(mergedPdf, fileName);
    } catch (e) {
      alert('Error al unir PDFs: ' + e.message);
    }
  });

// Convertir imágenes a PDF
 imgToPdfBtn.addEventListener('click', async () => {
  if (imageFiles.length === 0) {
    alert('Selecciona al menos una imagen.');
    return;
  }

  const fileName = await getCustomFileName('Imagenes_Convertidas.pdf');
  const pdfDoc = await PDFDocument.create();

    try {
      for (const imgFile of imageFiles) {
        const imgBytes = await imgFile.arrayBuffer();

        let img;
        // Intentar JPG, si falla intentar PNG
        try {
          img = await pdfDoc.embedJpg(imgBytes);
        } catch {
          img = await pdfDoc.embedPng(imgBytes);
        }

        const page = pdfDoc.addPage([img.width, img.height]);
        page.drawImage(img, {
          x: 0,
          y: 0,
          width: img.width,
          height: img.height,
        });
      }

    downloadAndSavePDF(pdfDoc, fileName);
    } catch (e) {
      alert('Error al convertir imágenes: ' + e.message);
    }
  });

  // Añadir números de página
  addPageNumsBtn.addEventListener('click', async () => {
  if (!singlePdfFile) {
    alert('Selecciona un PDF para añadir números de página.');
    return;
  }

  const fileName = await getCustomFileName('PDF_Con_Numeros.pdf');

    try {
      const arrayBuffer = await singlePdfFile.arrayBuffer();
      const pdfDoc = await PDFDocument.load(arrayBuffer);
      const pages = pdfDoc.getPages();
      const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

      pages.forEach((page, i) => {
        const { width } = page.getSize();
        const text = `${i+1}`;
        page.drawText(text, {
          x: width - 40,
          y: 15,
          size: 12,
          font,
          color: rgb(0, 0, 0),
        });
      });

      downloadAndSavePDF(pdfDoc, fileName);
    } catch (e) {
      alert('Error al añadir números: ' + e.message);
    }
  });

const orderPdfInput = document.getElementById('orderPdfInput');
const pageOrderList = document.getElementById('pageOrderList');
const orderPagesBtn = document.getElementById('orderPagesBtn');

let orderPdfFile = null;
let pageOrder = [];

orderPdfInput.addEventListener('change', async (e) => {
  orderPdfFile = e.target.files[0] || null;
  pageOrder = [];
  pageOrderList.innerHTML = '';

  if (!orderPdfFile) return;

  try {
    const arrayBuffer = await orderPdfFile.arrayBuffer();
    const pdfDoc = await PDFDocument.load(arrayBuffer);
    const pageCount = pdfDoc.getPageCount();

    // Inicializa orden natural
    pageOrder = Array.from({ length: pageCount }, (_, i) => i);

    renderPageOrderList();
  } catch (err) {
    alert('Error cargando PDF para ordenar: ' + err.message);
  }
});

function renderPageOrderList() {
  pageOrderList.innerHTML = '';
  pageOrder.forEach((pageIndex, i) => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.style.justifyContent = 'space-between';
    div.style.padding = '4px 8px';
    div.style.borderBottom = '1px solid #ddd';

    const label = document.createElement('span');
    label.textContent = `Página ${pageIndex + 1}`;

    const controls = document.createElement('div');

    const upBtn = document.createElement('button');
    upBtn.textContent = '↑';
    upBtn.style.marginRight = '5px';
    upBtn.disabled = (i === 0);
    upBtn.addEventListener('click', () => {
      if (i === 0) return;
      [pageOrder[i - 1], pageOrder[i]] = [pageOrder[i], pageOrder[i - 1]];
      renderPageOrderList();
    });

    const downBtn = document.createElement('button');
    downBtn.textContent = '↓';
    downBtn.disabled = (i === pageOrder.length - 1);
    downBtn.addEventListener('click', () => {
      if (i === pageOrder.length - 1) return;
      [pageOrder[i + 1], pageOrder[i]] = [pageOrder[i], pageOrder[i + 1]];
      renderPageOrderList();
    });

    controls.appendChild(upBtn);
    controls.appendChild(downBtn);
    div.appendChild(label);
    div.appendChild(controls);

    pageOrderList.appendChild(div);
  });
}

orderPagesBtn.addEventListener('click', async () => {
  if (!orderPdfFile) {
    alert('Selecciona un PDF primero.');
    return;
  }

  const fileName = await getCustomFileName('PDF_Ordenado.pdf');

  try {
    const arrayBuffer = await orderPdfFile.arrayBuffer();
    const originalPdf = await PDFDocument.load(arrayBuffer);
    const newPdf = await PDFDocument.create();

    for (const pageIndex of pageOrder) {
      const [copiedPage] = await newPdf.copyPages(originalPdf, [pageIndex]);
      newPdf.addPage(copiedPage);
    }

    downloadAndSavePDF(newPdf, fileName);

  } catch (err) {
    alert('Error al guardar PDF ordenado: ' + err.message);
  }
});


</script>

<div class="section">
  <h2>Historial</h2>
  <div id="savedFilesContainer">
    <p id="noFilesMessage">No hay archivos guardados todavía.</p>
    <ul id="savedFilesList" class="files-history"></ul>
  </div>
</div>

</body>
</html>
